<!DOCTYPE html><html lang="en"><head><title>my-plugin</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="my-plugin"><meta name="groc-project-path" content="my-plugin.coffee"><meta name="groc-github-url" content="https://github.com/sweetpi/pimatic"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><link rel="stylesheet" type="text/css" media="all" href="assets/customStyle.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sweetpi/pimatic/blob/master/my-plugin.coffee">my-plugin.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="plugin-template">Plugin template</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is an plugin template and mini tutorial for creating pimatic plugins. It will explain the 
basics of how the plugin system works and how a plugin should look like.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-plugin-code">The plugin code</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Your plugin must export a single function, that takes one argument and returns a instance of
your plugin class. The parameter is an envirement object containing all pimatic related functions
and classes. See the <a href="http://sweetpi.de/pimatic/docs/startup.html">startup.coffee</a> for details.</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="nf">(env) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="require-modules-included-in-pimatic">require modules included in pimatic</h3>

<p>To require modules that are included in pimatic use <code>env.require</code>. For available packages take 
a look at the dependencies section in pimatics package.json</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Require <a href="https://github.com/mozilla/node-convict">convict</a> for config validation.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">convict = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&quot;convict&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Require the <a href="https://github.com/kriskowal/q">Q</a> promise library</p></div></div><div class="code"><div class="wrapper">  <span class="nv">Q = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&#39;q&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Require the <a href="https://github.com/rhoot/cassert">cassert library</a>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">assert = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&#39;cassert&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Include you own depencies with nodes global require function:</p>

<pre><code>someThing = require 'someThing'
</code></pre></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="myplugin-class">MyPlugin class</h3>

<p>Create a class that extends the Plugin class and implements the following functions:</p></div></div><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="nx">MyPlugin</span> <span class="k">extends</span> <span class="nx">env</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">Plugin</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="init">init()</h4>

<p>The <code>init</code> function is called by the framework to ask your plugin to initialise.</p>

<h5 id="params">params:</h5>

<ul>
<li><code>app</code> is the [express] instance the framework is using.</li>
<li><code>framework</code> the framework itself</li>
<li><code>config</code> the properties the user specified as config for your plugin in the <code>plugins</code> 
section of the config.json file </li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nv">init: </span><span class="nf">(app, @framework, config) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Require your config shema</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@conf = </span><span class="nx">convict</span> <span class="nx">require</span><span class="p">(</span><span class="s">&quot;./my-plugin-config-shema&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and validate the given config.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@conf</span><span class="p">.</span><span class="nx">load</span> <span class="nx">config</span>
      <span class="nx">@conf</span><span class="p">.</span><span class="nx">validate</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>You can use <code>@conf.get "myOption"</code> to get a config option.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="createdevice">createDevice()</h4>

<p>The <code>createDevice</code> function is called by the framework for every device in the <code>devices</code>
section of the config.json file.
You should create your device here, if the class of the given deviceConfig matches on of 
yours.</p>

<h5 id="params">params:</h5>

<ul>
<li><code>deviceConfig</code> the properties the user specified in the <code>devices</code> section of the 
config.json file</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nv">createDevice: </span><span class="nf">(deviceConfig) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if the class option of the given config is...</p></div></div><div class="code"><div class="wrapper">      <span class="k">switch</span> <span class="nx">deviceConfig</span><span class="p">.</span><span class="nx">class</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>...matches your switch class</p></div></div><div class="code"><div class="wrapper">        <span class="k">when</span> <span class="s">&quot;MySwitch&quot;</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then create a instance of your device and register it</p></div></div><div class="code"><div class="wrapper">          <span class="nx">@framework</span><span class="p">.</span><span class="nx">registerDevice</span><span class="p">(</span><span class="k">new</span> <span class="nx">MySwitch</span> <span class="nx">deviceConfig</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and return true.</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>... not matching your classes</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then return false.</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="myswitch-class">MySwitch class</h3>

<p>An example class for a switch device</p></div></div><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="nx">MySwitch</span> <span class="k">extends</span> <span class="nx">env</span><span class="p">.</span><span class="nx">devices</span><span class="p">.</span><span class="nx">PowerSwitch</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="constructor">constructor()</h4>

<p>Your constructor function must assign a name and id to the device.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">constructor: </span><span class="nf">(deviceConfig) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Require your actuator config shema</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@conf = </span><span class="nx">convict</span> <span class="nx">require</span><span class="p">(</span><span class="s">&quot;./device-config-shema&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and validate the given device config.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@conf</span><span class="p">.</span><span class="nx">load</span> <span class="nx">deviceConfig</span>
      <span class="nx">@conf</span><span class="p">.</span><span class="nx">validate</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then assign the given name and id to the object.</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@name = </span><span class="nx">conf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;name&quot;</span>
      <span class="vi">@id = </span><span class="nx">conf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;id&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="changestatetostate">changeStateTo(state)</h4>

<p>The <code>changeStateTo</code> function should change the state of the switch, when called by the 
framework.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">changeStateTo: </span><span class="nf">(state) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If state is aleady set, just return a empty promise</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">@_state</span> <span class="o">is</span> <span class="nx">state</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">Q</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>else return a promise</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>that does the magic stuff</p></div></div><div class="code"><div class="wrapper">        <span class="nx">yourChangeStateImplementation</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and calls <code>PowerSwitch::_setState</code> so that <code>_state</code> is set and 
a event is emitted.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@_setState</span> <span class="nx">state</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h4 id="getstate">getState()</h4>

<p>Should return a promise with the state of the switch.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">getState: </span><span class="p">()</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the state is cached then return it</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="k">if</span> <span class="nx">@_state</span><span class="o">?</span> <span class="k">then</span> <span class="nx">Q</span> <span class="nx">@_state</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>else </p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span> <span class="o">=&gt;</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get the state from somwhere</p></div></div><div class="code"><div class="wrapper">        <span class="vi">@_state = </span><span class="nx">yourGetStateImplementation</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and return it.</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">@_state</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="finally">Finally</h3>

<p>Create a instance of my plugin</p></div></div><div class="code"><div class="wrapper">  <span class="nv">myPlugin = </span><span class="k">new</span> <span class="nx">MyPlugin</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and return it to the framework.</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="nx">myPlugin</span></div></div></div></div></body></html>